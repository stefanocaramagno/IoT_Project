{# 
  Template: dashboard.html

  Obiettivo
  ---------
  Implementare la pagina "Dashboard" del Web Backend (FastAPI + Jinja2), fornendo una vista unificata
  dell’intera città (tutti i distretti) e concentrando:
  - KPI principali (eventi totali, eventi critici, escalation, azioni coordinate);
  - stato sintetico per distretto (card con conteggi per severità e ultimo evento disponibile);
  - sezione analitica con grafici (Chart.js) alimentati da dataset JSON preparati lato server;
  - anteprima delle ultime attività (eventi e azioni, fino a 20 righe ciascuna).

  Ruolo nel sistema
  -----------------
  La pagina rappresenta il punto di ingresso principale della UI “operativa” e sintetizza:
  - il carico di eventi generato dagli agenti di distretto (sensor events);
  - la presenza di situazioni critiche (severity = high) e relative escalation;
  - l’output del coordinamento (azioni emesse dal CityCoordinator).
  I dati vengono prodotti lato Web Backend tramite endpoint dedicato (GET /dashboard), con possibilità
  di applicare una finestra temporale tramite parametro `window_minutes`.

  Dipendenze UI / JavaScript
  --------------------------
  - Chart.js è caricato via CDN nel blocco `{% block scripts %}`.
  - Lo script `/static/js/dashboard.js`:
    * intercetta il cambio della select `window_minutes` e invia automaticamente il form;
    * legge i dataset JSON dagli attributi `data-chart` dei canvas;
    * inizializza i grafici Chart.js sulle rispettive aree.
  - Layout e stile basati su TailwindCSS (caricato nel template base.html).

  Parametri e variabili attese dal template
  -----------------------------------------
  - now_utc: datetime (ultimo aggiornamento, mostrato in header).
  - window_minutes: int (finestra temporale selezionata in minuti; 0 = all time).
  - time_filtered: bool (true se window_minutes > 0).

  KPI:
  - total_events: int
  - critical_events: int (severity = "high")
  - escalations_triggered: int (conteggio situazioni critiche distinte che hanno generato escalation)
  - total_actions: int (azioni coordinate persistite)

  Distretto (cards):
  - district_cards: lista di record con chiavi:
    * name, status, total, high, medium, low, last_event
    * last_event (se presente): sensor_type, severity, timestamp

  Preview:
  - events_preview: lista degli ultimi eventi (max 20) nel contesto temporale selezionato
  - actions_preview: lista delle ultime azioni (max 20) nel contesto temporale selezionato

  Dataset per grafici (stringhe JSON marcate safe):
  - events_over_time_json
  - severity_distribution_json
  - events_by_district_severity_json
  - sensor_type_distribution_json
  - events_by_sensor_type_severity_json
  - critical_pipeline_json
  - actions_by_type_json

  Note di robustezza e UX
  -----------------------
  - Gestione esplicita dei casi “no data” (nessun evento/azione/distretto attivo).
  - Badge (stato distretto, severità, tipo azione) calcolati lato template per ridurre logica client.
  - Tabelle di preview scrollabili con header sticky per preservare leggibilità su dataset densi.
#}

{% extends "base.html" %}

{% block title %}Dashboard · Urban MAS{% endblock %}

{% block content %}
<section class="space-y-8">
  <!-- Header pagina: titolo + descrizione + selettore finestra temporale -->
  <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-50 sm:text-3xl">
        City Overview
      </h1>
      <p class="mt-1 max-w-2xl text-sm text-slate-400">
        Unified monitoring view of all districts: sensor activity, critical escalations and coordinated responses over the selected time window.
      </p>
    </div>

    <!-- Form GET: consente di filtrare la dashboard per finestra temporale -->
    <form
      method="get"
      class="flex flex-col gap-2 rounded-xl border border-slate-800 bg-slate-900/60 px-4 py-3 text-sm text-slate-300 shadow-sm md:flex-row md:items-center"
    >
      <div class="flex items-center gap-2">
        <span class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Time window
        </span>
        <select
          id="window-select"
          name="window_minutes"
          class="rounded-lg border border-slate-700 bg-slate-900 px-2 py-1 text-sm text-slate-100 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"
        >
          <option value="0" {% if window_minutes == 0 %}selected{% endif %}>All time</option>
          <option value="15" {% if window_minutes == 15 %}selected{% endif %}>Last 15 minutes</option>
          <option value="30" {% if window_minutes == 30 %}selected{% endif %}>Last 30 minutes</option>
          <option value="60" {% if window_minutes == 60 %}selected{% endif %}>Last 60 minutes</option>
          <option value="120" {% if window_minutes == 120 %}selected{% endif %}>Last 2 hours</option>
        </select>
      </div>
      <div class="text-xs text-slate-500 md:text-right">
        <span class="font-medium text-slate-400">Last update:</span>
        {{ now_utc.strftime("%Y-%m-%d %H:%M UTC") }}
      </div>
    </form>
  </div>

  <!-- KPI cards: metriche sintetiche di città -->
  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4">
    <article
      class="flex items-center justify-between rounded-2xl border border-slate-800 bg-slate-900/60 px-4 py-4 shadow-sm"
    >
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Total events
        </div>
        <div class="mt-1 text-2xl font-semibold text-slate-50">
          {{ total_events }}
        </div>
        <div class="mt-1 text-xs text-slate-500">
          {% if time_filtered and window_minutes > 0 %}
            In the last {{ window_minutes }} minutes
          {% else %}
            All time
          {% endif %}
        </div>
      </div>
      <div
        class="flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-500/10 text-emerald-400 ring-1 ring-emerald-500/30"
      >
        <span class="text-lg">Σ</span>
      </div>
    </article>

    <article
      class="flex items-center justify-between rounded-2xl border border-slate-800 bg-slate-900/60 px-4 py-4 shadow-sm"
    >
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Critical events
        </div>
        <div class="mt-1 text-2xl font-semibold text-rose-400">
          {{ critical_events }}
        </div>
        <div class="mt-1 text-xs text-slate-500">
          severity = "high"
          {% if time_filtered and window_minutes > 0 %}
            · last {{ window_minutes }} min
          {% else %}
            · all time
          {% endif %}
        </div>
      </div>
      <div
        class="flex h-10 w-10 items-center justify-center rounded-xl bg-rose-500/10 text-rose-400 ring-1 ring-rose-500/30"
      >
        !
      </div>
    </article>

    <article
      class="flex items-center justify-between rounded-2xl border border-slate-800 bg-slate-900/60 px-4 py-4 shadow-sm"
    >
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Escalations triggered
        </div>
        <div class="mt-1 text-2xl font-semibold text-amber-300">
          {{ escalations_triggered }}
        </div>
        <div class="mt-1 text-xs text-slate-500">
          Distinct critical situations escalated <br> to CityCoordinator
          {% if time_filtered and window_minutes > 0 %}
            · last {{ window_minutes }} min
          {% else %}
            · all time
          {% endif %}
        </div>
      </div>
      <div
        class="flex h-10 w-10 items-center justify-center rounded-xl bg-amber-500/10 text-amber-300 ring-1 ring-amber-500/30"
      >
        ↑
      </div>
    </article>

    <article
      class="flex items-center justify-between rounded-2xl border border-slate-800 bg-slate-900/60 px-4 py-4 shadow-sm"
    >
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Coordinated actions
        </div>
        <div class="mt-1 text-2xl font-semibold text-sky-400">
          {{ total_actions }}
        </div>
        <div class="mt-1 text-xs text-slate-500">
          Commands issued <br> by CityCoordinator
          {% if time_filtered and window_minutes > 0 %}
            · last {{ window_minutes }} min
          {% else %}
            · all time
          {% endif %}
        </div>
      </div>
      <div
        class="flex h-10 w-10 items-center justify-center rounded-xl bg-sky-500/10 text-sky-400 ring-1 ring-sky-500/30"
      >
        ⇄
      </div>
    </article>
  </div>

  <!-- Stato per distretto: card con severità e ultimo evento -->
  <section class="space-y-3">
    <header class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
        District status
      </h2>
      <p class="text-xs text-slate-500">
        Aggregated metrics per district based on the selected time configuration.
      </p>
    </header>

    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
      {% if district_cards %}
        {% for d in district_cards %}
          {# Mapping stato → badge (colore + label) #}
          {% if d.status == "critical" %}
            {% set badge_color = "bg-rose-500/10 text-rose-300 ring-rose-500/40" %}
            {% set status_label = "Critical" %}
          {% elif d.status == "alert" %}
            {% set badge_color = "bg-amber-500/10 text-amber-300 ring-amber-500/40" %}
            {% set status_label = "Alert" %}
          {% elif d.status == "normal" %}
            {% set badge_color = "bg-emerald-500/10 text-emerald-300 ring-emerald-500/40" %}
            {% set status_label = "Normal" %}
          {% else %}
            {% set badge_color = "bg-slate-700/40 text-slate-300 ring-slate-500/40" %}
            {% set status_label = "Inactive" %}
          {% endif %}

          <article
            class="flex flex-col justify-between rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
          >
            <div class="flex items-center justify-between gap-2">
              <div>
                <h3 class="text-sm font-semibold text-slate-50">
                  {{ d.name }}
                </h3>
                <p class="mt-1 text-xs text-slate-500">
                  Total events:
                  <span class="font-medium text-slate-200">{{ d.total }}</span>
                </p>
              </div>
              <span
                class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ring-1 {{ badge_color }}"
              >
                {{ status_label }}
              </span>
            </div>

            <dl class="mt-3 grid grid-cols-3 gap-2 text-xs text-slate-400">
              <div class="rounded-lg bg-slate-900/70 p-2">
                <dt class="text-[0.65rem] uppercase tracking-wide text-slate-500">
                  High
                </dt>
                <dd class="mt-1 text-sm font-semibold text-rose-300">
                  {{ d.high }}
                </dd>
              </div>
              <div class="rounded-lg bg-slate-900/70 p-2">
                <dt class="text-[0.65rem] uppercase tracking-wide text-slate-500">
                  Medium
                </dt>
                <dd class="mt-1 text-sm font-semibold text-amber-300">
                  {{ d.medium }}
                </dd>
              </div>
              <div class="rounded-lg bg-slate-900/70 p-2">
                <dt class="text-[0.65rem] uppercase tracking-wide text-slate-500">
                  Low
                </dt>
                <dd class="mt-1 text-sm font-semibold text-emerald-300">
                  {{ d.low }}
                </dd>
              </div>
            </dl>

            <div class="mt-3 border-t border-slate-800 pt-3 text-xs text-slate-500">
              {% if d.last_event %}
                <div class="flex justify-between gap-2">
                  <span class="truncate">
                    Last: {{ d.last_event.sensor_type }} · {{ d.last_event.severity }}
                  </span>
                  <span class="text-slate-600">
                    {{ d.last_event.timestamp }}
                  </span>
                </div>
              {% else %}
                <span class="text-slate-600">No events in this time configuration.</span>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <div
          class="col-span-full rounded-2xl border border-dashed border-slate-700 bg-slate-900/60 p-6 text-center text-sm text-slate-500"
        >
          No districts have reported events yet.
        </div>
      {% endif %}
    </div>
  </section>

  <!-- Sezione analitica: grafici Chart.js -->
  <section class="space-y-3">
    <header class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
        Events &amp; coordination analytics
      </h2>
      <p class="text-xs text-slate-500">
        Visual overview of event load, severity levels, sensor domains and coordinated responses across the city.
      </p>
    </header>

    <div class="space-y-4">
      <div class="grid grid-cols-1">
        <article
          class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
        >
          <header class="mb-2 flex items-center justify-between gap-2">
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
                Events over time
              </h3>
              <p class="mt-1 text-xs text-slate-500">
                Distribution of sensor events by severity over the selected time configuration.
              </p>
            </div>
          </header>
          <div class="h-64">
            <canvas
              id="events-over-time-chart"
              class="h-full w-full"
              data-chart='{{ events_over_time_json | safe }}'
            ></canvas>
          </div>
        </article>
      </div>

      <div class="grid grid-cols-1 gap-4 xl:grid-cols-3">
        {% if severity_distribution_json is defined %}
        <article
          class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
        >
          <header class="mb-2">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
              Event severity distribution
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Overall proportion of low, medium and high severity events.
            </p>
          </header>
          <div class="h-64">
            <canvas
              id="event-severity-chart"
              class="h-full w-full"
              data-chart='{{ severity_distribution_json | safe }}'
            ></canvas>
          </div>
        </article>
        {% endif %}

        {% if events_by_district_severity_json is defined %}
        <article
          class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm xl:col-span-2"
        >
          <header class="mb-2 flex items-center justify-between gap-2">
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
                Events by district &amp; severity
              </h3>
              <p class="mt-1 text-xs text-slate-500">
                Comparison of event volumes per district, broken down by severity level.
              </p>
            </div>
          </header>
          <div class="h-64">
            <canvas
              id="events-by-district-chart"
              class="h-full w-full"
              data-chart='{{ events_by_district_severity_json | safe }}'
            ></canvas>
          </div>
        </article>
        {% endif %}
      </div>

      <div class="grid grid-cols-1 gap-4 xl:grid-cols-3">
        {% if sensor_type_distribution_json is defined %}
        <article
          class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
        >
          <header class="mb-2">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
              Sensor type distribution
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Proportion of events generated by each sensor domain (traffic, noise, air quality, etc.).
            </p>
          </header>
          <div class="h-64">
            <canvas
              id="sensor-type-distribution-chart"
              class="h-full w-full"
              data-chart='{{ sensor_type_distribution_json | safe }}'
            ></canvas>
          </div>
        </article>
        {% endif %}

        {% if events_by_sensor_type_severity_json is defined %}
        <article
          class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm xl:col-span-2"
        >
          <header class="mb-2 flex items-center justify-between gap-2">
            <div>
              <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
                Events by sensor type &amp; severity
              </h3>
              <p class="mt-1 text-xs text-slate-500">
                Comparison of event volumes per sensor domain, broken down by severity level.
              </p>
            </div>
          </header>
          <div class="h-64">
            <canvas
              id="events-by-sensor-type-chart"
              class="h-full w-full"
              data-chart='{{ events_by_sensor_type_severity_json | safe }}'
            ></canvas>
          </div>
        </article>
        {% endif %}
      </div>

      <div class="grid grid-cols-1 gap-4 xl:grid-cols-2">
        {% if critical_pipeline_json is defined %}
        <article
          class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
        >
          <header class="mb-2">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
              Critical events → escalations → actions
            </h3>
            <p class="text-xs text-slate-500">
              Flow of critical events that are escalated and finally translated into coordination actions.
            </p>
          </header>
          <div class="h-64">
            <canvas
              id="critical-pipeline-chart"
              class="h-full w-full"
              data-chart='{{ critical_pipeline_json | safe }}'
            ></canvas>
          </div>
        </article>
        {% endif %}

        {% if actions_by_type_json is defined %}
        <article
          class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
        >
          <header class="mb-2">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
              Actions by type
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Distribution of coordination commands grouped by action type.
            </p>
          </header>
          <div class="h-64">
            <canvas
              id="actions-by-type-chart"
              class="h-full w-full"
              data-chart='{{ actions_by_type_json | safe }}'
            ></canvas>
          </div>
        </article>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Anteprima attività: ultime righe di events/actions -->
  <section class="space-y-3">
    <header class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
        Latest activity overview
      </h2>
      <p class="text-xs text-slate-500">
        Snapshot of the most recent sensor events and coordination actions across the city.
      </p>
    </header>

    <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
      <!-- Events preview -->
      <article
        class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
      >
        <header class="mb-3 flex items-center justify-between gap-2">
          <div>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
              Events preview
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Latest 20 events matching the current time window.
            </p>
          </div>
          <a
            href="/events"
            class="inline-flex items-center text-xs font-medium text-emerald-400 hover:text-emerald-300"
          >
            View all
            <span class="ml-1 text-[0.65rem]">→</span>
          </a>
        </header>

        {% if events_preview %}
          <div class="max-h-80 overflow-auto rounded-xl border border-slate-800/80">
            <table class="min-w-full text-left text-xs">
              <thead class="sticky top-0 z-10 bg-slate-900/95 text-[0.65rem] uppercase tracking-wide text-slate-500">
                <tr>
                  <th class="px-3 py-2">ID</th>
                  <th class="px-3 py-2">Timestamp</th>
                  <th class="px-3 py-2">Created at</th>
                  <th class="px-3 py-2">District</th>
                  <th class="px-3 py-2">Sensor</th>
                  <th class="px-3 py-2">Value</th>
                  <th class="px-3 py-2">Severity</th>
                  <th class="px-3 py-2">Topic</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800 bg-slate-950/40">
                {% for e in events_preview %}
                  {% set sev = (e.severity or "")|lower %}
                  {% if sev == "high" %}
                    {% set sev_color = "bg-rose-500/15 text-rose-300 ring-rose-500/40" %}
                  {% elif sev == "medium" %}
                    {% set sev_color = "bg-amber-500/15 text-amber-300 ring-amber-500/40" %}
                  {% elif sev == "low" %}
                    {% set sev_color = "bg-emerald-500/15 text-emerald-300 ring-emerald-500/40" %}
                  {% else %}
                    {% set sev_color = "bg-slate-600/20 text-slate-200 ring-slate-500/40" %}
                  {% endif %}

                  <tr class="hover:bg-slate-900/70">
                    <td class="px-3 py-2 text-slate-500 whitespace-nowrap">
                      {{ e.id }}
                    </td>
                    <td class="px-3 py-2 text-slate-400 whitespace-nowrap">
                      {{ e.timestamp }}
                    </td>
                    <td class="px-3 py-2 text-slate-400 whitespace-nowrap">
                      {% if e.created_at %}
                        {{ e.created_at.strftime("%Y-%m-%d %H:%M:%S UTC") }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="px-3 py-2 text-slate-100 whitespace-nowrap">
                      {{ e.district }}
                    </td>
                    <td class="px-3 py-2 text-slate-100 whitespace-nowrap">
                      {{ e.sensor_type }}
                    </td>
                    <td class="px-3 py-2 text-slate-200 whitespace-nowrap">
                      {% if e.unit %}
                        {{ e.value }} {{ e.unit }}
                      {% else %}
                        {{ e.value }}
                      {% endif %}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                      <span
                        class="inline-flex items-center rounded-full px-2 py-0.5 text-[0.65rem] font-medium ring-1 {{ sev_color }}"
                      >
                        {{ e.severity }}
                      </span>
                    </td>
                    <td class="px-3 py-2 text-slate-400 whitespace-nowrap">
                      {{ e.topic }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <p class="mt-2 text-[0.65rem] text-slate-600">
            Showing {{ events_preview|length }} recent events (latest 20)
            {% if time_filtered and window_minutes > 0 %}
              · Time window: last {{ window_minutes }} minutes
            {% else %}
              · Time window: all time
            {% endif %}
          </p>
        {% else %}
          <p class="text-xs text-slate-600">
            No events available for this time window.
          </p>
        {% endif %}
      </article>

      <!-- Actions preview -->
      <article
        class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-sm"
      >
        <header class="mb-3 flex items-center justify-between gap-2">
          <div>
            <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
              Coordinated actions preview
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Latest 20 coordination actions issued by the CityCoordinator.
            </p>
          </div>
          <a
            href="/actions"
            class="inline-flex items-center text-xs font-medium text-emerald-400 hover:text-emerald-300"
          >
            View all
            <span class="ml-1 text-[0.65rem]">→</span>
          </a>
        </header>

        {% if actions_preview %}
          <div class="max-h-80 overflow-auto rounded-xl border border-slate-800/80">
            <table class="min-w-full table-fixed text-left text-xs">
              <thead class="sticky top-0 z-10 bg-slate-900/95 text-[0.65rem] uppercase tracking-wide text-slate-500">
                <tr>
                  <th class="px-3 py-2 whitespace-nowrap">ID</th>
                  <th class="px-3 py-2 whitespace-nowrap">Created at</th>
                  <th class="px-3 py-2 whitespace-nowrap">Source</th>
                  <th class="px-3 py-2 whitespace-nowrap">Target</th>
                  <th class="px-3 py-2 whitespace-nowrap">Action type</th>
                  <th class="px-3 py-2 whitespace-nowrap">Reason</th>
                  <th class="px-3 py-2 whitespace-nowrap">Snapshot (summary)</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800 bg-slate-950/40">
                {% for a in actions_preview %}
                  {% set atype = (a.action_type or "") %}
                  {% set atype_lower = atype|lower %}
                  {% if "reroute" in atype_lower %}
                    {% set badge_color = "bg-sky-500/15 text-sky-300 ring-sky-500/40" %}
                  {% elif "alert" in atype_lower %}
                    {% set badge_color = "bg-amber-500/15 text-amber-300 ring-amber-500/40" %}
                  {% elif "limit" in atype_lower %}
                    {% set badge_color = "bg-rose-500/15 text-rose-300 ring-rose-500/40" %}
                  {% else %}
                    {% set badge_color = "bg-emerald-500/15 text-emerald-300 ring-emerald-500/40" %}
                  {% endif %}

                  <tr class="hover:bg-slate-900/70">
                    <td class="px-3 py-2 text-slate-500 whitespace-nowrap">
                      {{ a.id }}
                    </td>
                    <td class="px-3 py-2 text-slate-400 whitespace-nowrap">
                      {{ a.created_at_str }}
                    </td>
                    <td class="px-3 py-2 text-slate-100 whitespace-nowrap">
                      {{ a.source_district }}
                    </td>
                    <td class="px-3 py-2 text-slate-100 whitespace-nowrap">
                      {{ a.target_district }}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap">
                      <span
                        class="inline-flex items-center rounded-full px-2 py-0.5 text-[0.65rem] font-medium ring-1 {{ badge_color }}"
                      >
                        {{ a.action_type }}
                      </span>
                    </td>
                    <td class="px-3 py-2 text-slate-300 max-w-[14rem] truncate">
                      {% if a.reason %}
                        {{ a.reason }}
                      {% else %}
                        <span class="text-slate-500">–</span>
                      {% endif %}
                    </td>
                    <td class="px-3 py-2 text-slate-400 max-w-[14rem] truncate">
                      {{ a.snapshot_summary }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <p class="mt-2 text-[0.65rem] text-slate-600">
            Showing {{ actions_preview|length }} recent actions (latest 20)
            {% if time_filtered and window_minutes > 0 %}
              · Time window: last {{ window_minutes }} minutes
            {% else %}
              · Time window: all time
            {% endif %}
          </p>
        {% else %}
          <p class="text-xs text-slate-600">
            No coordination actions available for this time window.
          </p>
        {% endif %}
      </article>
    </div>
  </section>
</section>
{% endblock %}

{% block scripts %}
  <!-- Chart.js: libreria per la generazione dei grafici nella dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Script applicativo: parsing dataset dai canvas (data-chart) e inizializzazione grafici -->
  <script src="/static/js/dashboard.js"></script>
{% endblock %}