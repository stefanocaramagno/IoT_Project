{% extends "base.html" %}

{% block title %}Events · Urban MAS{% endblock %}

{% block content %}
<section class="space-y-8">
  <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-50 sm:text-3xl">
        Events – Event Explorer
      </h1>
      <p class="mt-1 max-w-2xl text-sm text-slate-400">
        Analytical explorer of raw sensor events collected by district agents, with filters by district, severity, sensor type, time window and free-text search on topics.
      </p>
    </div>

    <div class="text-xs text-slate-500 md:text-right">
      <div>
        <span class="font-medium text-slate-400">Last update:</span>
        {{ now_utc.strftime("%Y-%m-%d %H:%M UTC") }}
      </div>
      <div>
        Time window:
        {% if time_filtered and window_minutes > 0 %}
          <span class="font-medium text-slate-300">last {{ window_minutes }} minutes</span>
        {% else %}
          <span class="font-medium text-slate-300">all time</span>
        {% endif %}
      </div>
    </div>
  </div>

  <form
    method="get"
    class="space-y-3 rounded-2xl border border-slate-800 bg-slate-900/70 px-4 py-4 text-sm text-slate-200 shadow-sm"
  >
    <div class="grid grid-cols-1 gap-3 md:grid-cols-4">
      <div class="flex flex-col gap-1">
        <label for="f-district" class="text-xs font-medium uppercase tracking-wide text-slate-500">
          District
        </label>
        <select
          id="f-district"
          name="district"
          class="w-full rounded-lg border border-slate-700 bg-slate-950 px-2 py-1 text-sm text-slate-100 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"
        >
          <option value="">All districts</option>
          {% for d in districts %}
            <option value="{{ d }}" {% if selected_district == d %}selected{% endif %}>
              {{ d }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="flex flex-col gap-1">
        <label for="f-severity" class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Severity
        </label>
        <select
          id="f-severity"
          name="severity"
          class="w-full rounded-lg border border-slate-700 bg-slate-950 px-2 py-1 text-sm text-slate-100 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"
        >
          <option value="">All severities</option>
          {% for s in severities %}
            <option value="{{ s }}" {% if selected_severity == s %}selected{% endif %}>
              {{ s }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="flex flex-col gap-1">
        <label for="f-sensor-type" class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Sensor type
        </label>
        <select
          id="f-sensor-type"
          name="sensor_type"
          class="w-full rounded-lg border border-slate-700 bg-slate-950 px-2 py-1 text-sm text-slate-100 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"
        >
          <option value="">All types</option>
          {% for t in sensor_types %}
            <option value="{{ t }}" {% if selected_sensor_type == t %}selected{% endif %}>
              {{ t }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="flex flex-col gap-1">
        <label for="f-window" class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Time window
        </label>
        <select
          id="f-window"
          name="window_minutes"
          class="w-full rounded-lg border border-slate-700 bg-slate-950 px-2 py-1 text-sm text-slate-100 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"
        >
          <option value="0" {% if window_minutes == 0 %}selected{% endif %}>All time</option>
          <option value="15" {% if window_minutes == 15 %}selected{% endif %}>Last 15 minutes</option>
          <option value="30" {% if window_minutes == 30 %}selected{% endif %}>Last 30 minutes</option>
          <option value="60" {% if window_minutes == 60 %}selected{% endif %}>Last 60 minutes</option>
          <option value="120" {% if window_minutes == 120 %}selected{% endif %}>Last 2 hours</option>
        </select>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-3 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)_auto]">
      <div class="flex flex-col gap-1">
        <label for="f-q" class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Search
        </label>
        <input
          id="f-q"
          name="q"
          type="text"
          value="{{ q }}"
          placeholder="Search in district, sensor type or topic..."
          class="w-full rounded-lg border border-slate-700 bg-slate-950 px-3 py-1 text-sm text-slate-100 outline-none placeholder:text-slate-600 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"
        />
      </div>

      <div class="flex flex-col gap-1">
        <label for="f-limit" class="text-xs font-medium uppercase tracking-wide text-slate-500">
          Limit
        </label>
        <select
          id="f-limit"
          name="limit"
          class="w-full rounded-lg border border-slate-700 bg-slate-950 px-2 py-1 text-sm text-slate-100 outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"
        >
          <option value="0" {% if limit == 0 %}selected{% endif %}>All</option>
          <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
          <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
        </select>
      </div>

      <div class="flex items-end justify-start gap-2 md:justify-end">
        <button
          type="submit"
          class="inline-flex items-center rounded-lg bg-emerald-500 px-3 py-1.5 text-xs font-semibold text-slate-950 shadow-sm hover:bg-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 focus:ring-offset-slate-900"
        >
          Apply filters
        </button>
        <a
          href="/events"
          class="inline-flex items-center rounded-lg border border-slate-700 bg-slate-900 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:bg-slate-800"
        >
          Reset
        </a>
      </div>
    </div>
  </form>

  <section
    class="grid grid-cols-1 gap-4 text-xs text-slate-300 sm:grid-cols-2 lg:grid-cols-3"
  >
    <div class="rounded-2xl border border-slate-800 bg-slate-900/70 px-3 py-3">
      <div class="text-[0.65rem] uppercase tracking-wide text-slate-500">
        Filtered events
      </div>
      <div class="mt-1 text-lg font-semibold text-slate-50">
        {{ filtered_events_count }}
      </div>
      <div class="mt-1 text-[0.7rem] text-slate-500">
        {% if limit == 0 %}
          Showing
          <span class="font-medium text-slate-300">{{ filtered_events_count }}</span>
          events (all results) · Total in DB:
          <span class="font-medium text-slate-300">{{ total_events_count }}</span>
        {% else %}
          Showing up to
          <span class="font-medium text-slate-300">{{ limit }}</span>
          events · Total in DB:
          <span class="font-medium text-slate-300">{{ total_events_count }}</span>
        {% endif %}
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/70 px-3 py-3">
      <div class="text-[0.65rem] uppercase tracking-wide text-slate-500">
        Critical events (severity = high)
      </div>
      <div class="mt-1 text-lg font-semibold text-rose-300">
        {{ filtered_critical_count }}
      </div>
      <div class="mt-1 text-[0.7rem] text-slate-500">
        In current filtered result set.
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/70 px-3 py-3">
      <div class="text-[0.65rem] uppercase tracking-wide text-slate-500">
        Active filters
      </div>
      <ul class="mt-1 space-y-0.5 text-[0.7rem] text-slate-400">
        <li>
          District:
          <span class="font-medium text-slate-200">
            {{ selected_district if selected_district else "All" }}
          </span>
        </li>
        <li>
          Severity:
          <span class="font-medium text-slate-200">
            {{ selected_severity if selected_severity else "All" }}
          </span>
        </li>
        <li>
          Sensor type:
          <span class="font-medium text-slate-200">
            {{ selected_sensor_type if selected_sensor_type else "All" }}
          </span>
        </li>
        <li>
          Time window:
          <span class="font-medium text-slate-200">
            {% if time_filtered and window_minutes > 0 %}
              last {{ window_minutes }} minutes
            {% else %}
              all time
            {% endif %}
          </span>
        </li>
        <li>
          Limit:
          <span class="font-medium text-slate-200">
            {% if limit == 0 %}All{% else %}{{ limit }}{% endif %}
          </span>
        </li>
        <li>
          Search:
          <span class="font-medium text-slate-200">
            {{ q if q else "—" }}
          </span>
        </li>
      </ul>
    </div>
  </section>

  <section class="space-y-3">
    <header class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
      <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
        Event list
      </h2>
      <p class="text-xs text-slate-500">
        Click on a row (or card on mobile) to inspect the full event details.
      </p>
    </header>

    {% if events %}
      <div class="hidden max-h-[640px] overflow-auto rounded-2xl border border-slate-800 bg-slate-950/40 md:block">
        <table class="min-w-full text-left text-xs">
          <thead class="sticky top-0 z-10 bg-slate-900/95 text-[0.65rem] uppercase tracking-wide text-slate-500">
            <tr>
              <th class="px-3 py-2">ID</th>
              <th class="px-3 py-2">Timestamp</th>
              <th class="px-3 py-2">Created at</th>
              <th class="px-3 py-2">District</th>
              <th class="px-3 py-2">Sensor</th>
              <th class="px-3 py-2">Value</th>
              <th class="px-3 py-2">Severity</th>
              <th class="px-3 py-2">Topic</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800">
            {% for e in events %}
              {% set sev = (e.severity or "")|lower %}
              {% if sev == "high" %}
                {% set sev_color = "bg-rose-500/15 text-rose-300 ring-rose-500/40" %}
              {% elif sev == "medium" %}
                {% set sev_color = "bg-amber-500/15 text-amber-300 ring-amber-500/40" %}
              {% elif sev == "low" %}
                {% set sev_color = "bg-emerald-500/15 text-emerald-300 ring-emerald-500/40" %}
              {% else %}
                {% set sev_color = "bg-slate-600/20 text-slate-200 ring-slate-500/40" %}
              {% endif %}

              <tr
                class="bg-slate-950/40 hover:bg-slate-900/80 cursor-pointer"
                data-event-row
                data-event-id="{{ e.id }}"
                data-event-district="{{ e.district }}"
                data-event-sensor="{{ e.sensor_type }}"
                data-event-value="{% if e.value is not none %}{{ e.value }}{% endif %}"
                data-event-unit="{{ e.unit or '' }}"
                data-event-severity="{{ e.severity or '' }}"
                data-event-timestamp="{{ e.timestamp }}"
                data-event-topic="{{ e.topic or '' }}"
                data-event-created="{% if e.created_at %}{{ e.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}{% endif %}"
              >
                <td class="px-3 py-2 text-slate-500">
                  {{ e.id }}
                </td>
                <td class="px-3 py-2 text-slate-400">
                  {{ e.timestamp }}
                </td>
                <td class="px-3 py-2 text-slate-400">
                  {% if e.created_at %}
                    {{ e.created_at.strftime("%Y-%m-%d %H:%M:%S UTC") }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="px-3 py-2 text-slate-100">
                  {{ e.district }}
                </td>
                <td class="px-3 py-2 text-slate-100">
                  {{ e.sensor_type }}
                </td>
                <td class="px-3 py-2 text-slate-200">
                  {% if e.unit %}
                    {{ e.value }} {{ e.unit }}
                  {% else %}
                    {{ e.value }}
                  {% endif %}
                </td>
                <td class="px-3 py-2">
                  <span
                    class="inline-flex items-center rounded-full px-2 py-0.5 text-[0.65rem] font-medium ring-1 {{ sev_color }}"
                  >
                    {{ e.severity }}
                  </span>
                </td>
                <td class="px-3 py-2 text-slate-400">
                  {{ e.topic }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="space-y-3 md:hidden">
        {% for e in events %}
          {% set sev = (e.severity or "")|lower %}
          {% if sev == "high" %}
            {% set sev_color = "bg-rose-500/15 text-rose-300 ring-rose-500/40" %}
          {% elif sev == "medium" %}
            {% set sev_color = "bg-amber-500/15 text-amber-300 ring-amber-500/40" %}
          {% elif sev == "low" %}
            {% set sev_color = "bg-emerald-500/15 text-emerald-300 ring-emerald-500/40" %}
          {% else %}
            {% set sev_color = "bg-slate-600/20 text-slate-200 ring-slate-500/40" %}
          {% endif %}

          <article
            class="cursor-pointer rounded-2xl border border-slate-800 bg-slate-900/70 p-3 shadow-sm"
            data-event-row
            data-event-id="{{ e.id }}"
            data-event-district="{{ e.district }}"
            data-event-sensor="{{ e.sensor_type }}"
            data-event-value="{% if e.value is not none %}{{ e.value }}{% endif %}"
            data-event-unit="{{ e.unit or '' }}"
            data-event-severity="{{ e.severity or '' }}"
            data-event-timestamp="{{ e.timestamp }}"
            data-event-topic="{{ e.topic or '' }}"
            data-event-created="{% if e.created_at %}{{ e.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') }}{% endif %}"
          >
            <div class="flex items-center justify-between gap-2">
              <div class="text-sm font-semibold text-slate-50">
                #{{ e.id }} · {{ e.district }}
              </div>
              <span
                class="inline-flex items-center rounded-full px-2 py-0.5 text-[0.65rem] font-medium ring-1 {{ sev_color }}"
              >
                {{ e.severity }}
              </span>
            </div>
            <div class="mt-1 text-xs text-slate-400">
              {{ e.timestamp }}
            </div>
            <div class="mt-1 text-xs text-slate-400">
              Sensor: <span class="text-slate-200">{{ e.sensor_type }}</span>
            </div>
            <div class="mt-1 text-xs text-slate-300">
              Value:
              {% if e.unit %}
                {{ e.value }} {{ e.unit }}
              {% else %}
                {{ e.value }}
              {% endif %}
            </div>
            <div class="mt-1 text-[0.7rem] text-slate-500">
              Topic: {{ e.topic }}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div
        class="rounded-2xl border border-dashed border-slate-700 bg-slate-900/60 p-6 text-center text-sm text-slate-500"
      >
        No events match the selected filters.
        <br />
        Try relaxing the time window or removing some filters.
      </div>
    {% endif %}
  </section>
</section>

<div
  id="event-modal"
  class="fixed inset-0 z-50 hidden flex items-center justify-center px-4"
>
  <div
    data-modal-overlay
    class="absolute inset-0 bg-slate-950/80"
  ></div>
  <div
    class="relative z-10 w-full max-w-lg rounded-2xl border border-slate-800 bg-slate-900/95 p-5 shadow-xl"
  >
    <header class="mb-3 flex items-center justify-between gap-2">
      <div>
        <h3 class="text-sm font-semibold text-slate-50">
          Event details
        </h3>
        <p class="text-xs text-slate-500">
          Full event data as persisted by the web backend, including timestamp and originating topic.
        </p>
      </div>
      <button
        type="button"
        data-modal-close
        class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-slate-700 bg-slate-900 text-slate-400 hover:bg-slate-800 hover:text-slate-100"
      >
        ✕
      </button>
    </header>

    <div class="space-y-4 text-xs text-slate-300">
      <section class="space-y-2">
        <h4 class="text-[0.7rem] font-semibold uppercase tracking-wide text-slate-500">
          Event
        </h4>
        <dl class="space-y-2">
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">ID</dt>
            <dd data-field="id" class="font-medium text-slate-100"></dd>
          </div>
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">Created at</dt>
            <dd data-field="created_at" class="text-slate-100"></dd>
          </div>
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">District</dt>
            <dd data-field="district" class="font-medium text-slate-100"></dd>
          </div>
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">Sensor type</dt>
            <dd data-field="sensor_type" class="font-medium text-slate-100"></dd>
          </div>
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">Value</dt>
            <dd data-field="value" class="text-slate-100"></dd>
          </div>
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">Severity</dt>
            <dd data-field="severity" class="text-slate-100"></dd>
          </div>
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">Timestamp</dt>
            <dd data-field="timestamp" class="text-slate-100"></dd>
          </div>
          <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-2">
            <dt class="text-slate-500">Topic</dt>
            <dd data-field="topic" class="text-slate-100 break-all"></dd>
          </div>
        </dl>
      </section>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="/static/js/events.js"></script>
{% endblock %}